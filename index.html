<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Visualizador de FDS Offline</title>
  <style>
    :root { --azul:#004080; }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: Arial, sans-serif; background:#f5f5f5;
      display:flex; flex-direction:column; min-height:100vh;
    }
    header {
      position: sticky; top:0; z-index:10;
      background:var(--azul); color:#fff; padding:10px;
      display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:space-between;
    }
    .menu { display:flex; gap:8px; flex-wrap:wrap; }
    button {
      background:#fff; color:var(--azul); border:none; padding:10px 14px;
      border-radius:8px; font-weight:700; cursor:pointer; font-size:16px;
    }
    button:active { transform: scale(0.98); }
    #visor { flex:1; width:100%; border:none; min-height:50vh; }

    /* Modal */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6);
      z-index:1000; align-items:center; justify-content:center; padding:16px; }
    .modal-content { background:#fff; border-radius:12px; padding:16px; width:100%; max-width:900px; max-height:90vh; overflow:auto; }
    .modal-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
    .close { background:transparent; border:none; font-size:28px; color:#c00; cursor:pointer; }
    .tools { display:flex; gap:8px; flex-wrap:wrap; }
    input[type="search"] { padding:8px 10px; border:1px solid #ccc; border-radius:8px; min-width:220px; }

    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:var(--azul); color:#fff; position:sticky; top:0; }
    tr:nth-child(even){ background:#fafafa; }

    @media (max-width:480px){
      button { font-size:15px; padding:10px 12px; }
      .modal-content { padding:12px; }
      th, td { font-size:14px; padding:6px; }
    }
  </style>
</head>
<body>
  <header>
    <strong>üìÑ Selecione o documento:</strong>
    <div class="menu">
      <button onclick="abrirPDF('FDS_ORTONEX_023.pdf')">ORTONEX</button>
      <button onclick="abrirPDF('FDS_HIPOCLORITO_65.pdf')">HIPOCLORITO</button>
      <button onclick="abrirPDF('FDS_TRICLORO.pdf')">TRICLORO</button>
      <button onclick="abrirModal()">‚ÑπÔ∏è Informa√ß√µes</button>
      <button onclick="atualizarApp()">‚ü≥ Atualizar app</button>
    </div>
  </header>

  <iframe id="visor" src="FDS_ORTONEX_023.pdf" title="Visualizador de PDF"></iframe>

  <!-- Modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="tituloInfo">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="tituloInfo">üìä Produtos utilizados em cada sistema</h2>
        <div class="tools">
          <input id="busca" type="search" placeholder="Pesquisar sistema..." oninput="filtrar()" />
          <button class="close" onclick="fecharModal()" aria-label="Fechar">&times;</button>
        </div>
      </div>
      <div id="tabelaWrap">
        <!-- Tabela gerada via JS a partir de info.json -->
      </div>
    </div>
  </div>

  <script>
    function abrirPDF(nomeArquivo){ document.getElementById('visor').src = nomeArquivo; }

    // Modal + tabela din√¢mica
    let linhasOriginais = [];
    function abrirModal(){
      document.getElementById('modal').style.display = 'flex';
      carregarTabela();
    }
    function fecharModal(){ document.getElementById('modal').style.display = 'none'; }

    async function carregarTabela(){
      try{
        const res = await fetch('info.json', { cache: 'no-store' }); // for√ßa checar vers√£o nova
        const dados = await res.json();
        montarTabela(dados);
      }catch(e){
        document.getElementById('tabelaWrap').innerHTML =
          '<p>N√£o foi poss√≠vel carregar as informa√ß√µes agora.</p>';
      }
    }

    function montarTabela(dados){
      const head = `
        <table id="tabela">
          <thead>
            <tr>
              <th>Sistema de √Ågua</th>
              <th>TRICLORO 20G</th>
              <th>ORTOPOLIFOSFATO DE S√ìDIO</th>
              <th>HIPOCLORITO DE C√ÅLCIO 65%</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>`;
      document.getElementById('tabelaWrap').innerHTML = head;
      const tbody = document.querySelector('#tabela tbody');
      linhasOriginais = dados.map(row => ([
        row.sistema || '',
        row.tricloro || '',
        row.orto || '',
        row.hipoclorito || ''
      ]));
      render(linhasOriginais);
    }

    function render(linhas){
      const tbody = document.querySelector('#tabela tbody');
      tbody.innerHTML = linhas.map(cells => `
        <tr>${cells.map(c => `<td>${c || ''}</td>`).join('')}</tr>
      `).join('');
    }

    function filtrar(){
      const q = document.getElementById('busca').value.toLowerCase().trim();
      if(!q){ render(linhasOriginais); return; }
      const filtradas = linhasOriginais.filter(l => (l[0]||'').toLowerCase().includes(q));
      render(filtradas);
    }

    // Service Worker ‚Äì registre SEM barra inicial no GitHub Pages
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(reg => {
          console.log('SW registrado', reg.scope);
          // Detectar atualiza√ß√£o do SW
          if (reg.waiting) reg.waiting.postMessage({type:'SKIP_WAITING'});
          reg.addEventListener('updatefound', () => {
            const newSW = reg.installing;
            newSW?.addEventListener('statechange', () => {
              if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                // nova vers√£o pronta
                console.log('Nova vers√£o instalada; recarregue para aplicar.');
              }
            });
          });
        })
        .catch(err => console.log('Erro ao registrar SW:', err));
    }

    // Bot√£o "Atualizar app": limpa caches + for√ßa update do SW + recarrega
    async function atualizarApp(){
      try {
        // Apaga todos os caches desta origem
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
        // For√ßa update do SW
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.update()));
      } finally {
        location.reload();
      }
    }
  </script>
</body>
</html>
